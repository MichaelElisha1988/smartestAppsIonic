<ion-content [fullscreen]="true">
  <section class="recepies">
    <div class="add-recipe-section">
        <button class="add-btn" (click)="toggleAddMode()"></button>
    </div>

    @if(isAddMode()) {
    <div class="add-recipe-overlay">
        <div class="add-recipe-container">
            <div class="wizard-header">
                <div class="step-indicator" [class.active]="currentStep() >= 1" [class.completed]="currentStep() > 1">
                    <div class="circle">1</div>
                </div>
                <div class="step-indicator" [class.active]="currentStep() >= 2" [class.completed]="currentStep() > 2">
                    <div class="circle">2</div>
                </div>
                <div class="step-indicator" [class.active]="currentStep() >= 3">
                    <div class="circle">3</div>
                </div>
            </div>

            <form [formGroup]="addRecipeForm" (submit)="saveCustomRecipe()">
                <div class="form-scroll-container">
                    @switch (currentStep()) {
                        @case (1) {
                            <div class="step-content fade-in">
                                <input type="text" formControlName="strMeal" placeholder="Recipe Name *" />
                                <div class="row">
                                    <input type="text" formControlName="strCategory" placeholder="Category *" />
                                    <input type="text" formControlName="strArea" placeholder="Area *" />
                                </div>
                                <div class="image-input-group">
                                    <input type="text" formControlName="strMealThumb" placeholder="Image URL (optional)" />
                                    <button type="button" class="suggest-btn" (click)="getSuggestions()" title="Get Suggestions from Title">
                                        Suggest
                                    </button>
                                </div>
                                
                                @if(suggestedImages().length > 0) {
                                    <div class="suggestions-container">
                                        @for(img of suggestedImages(); track $index) {
                                            <img [src]="img" (click)="selectSuggestion(img)" class="suggestion-thumb" />
                                        }
                                    </div>
                                }
                                <input type="text" formControlName="strYoutube" placeholder="Youtube Link (optional)" />
                                <input type="text" formControlName="strTags" placeholder="Tags (comma separated)" />
                            </div>
                        }
                        @case (2) {
                            <div class="step-content fade-in">
                                <h3>Ingredients</h3>
                                <div class="ingredients-section" formArrayName="ingredients">
                                    @for(group of ingredients.controls; track $index) {
                                        <div [formGroupName]="$index" class="ingredient-row">
                                            <input type="text" formControlName="ingredient" placeholder="Ingredient" />
                                            <input type="text" formControlName="measure" placeholder="Measure" />
                                            <button type="button" class="remove-btn" (click)="removeIngredient($index)">X</button>
                                        </div>
                                    }
                                    <button type="button" class="add-ingredient-btn" (click)="addIngredient()">+ Add Ingredient</button>
                                </div>
                            </div>
                        }
                        @case (3) {
                            <div class="step-content fade-in">
                                <h3>Instructions</h3>
                                <textarea formControlName="strInstructions" placeholder="Step-by-step instructions... *" rows="10"></textarea>
                            </div>
                        }
                    }
                </div>

                <div class="form-actions wizard-actions">
                    @if(currentStep() === 1) {
                        <button type="button" class="cancel-btn" (click)="toggleAddMode()">Cancel</button>
                        <button type="button" class="save-btn" (click)="nextStep()">Next</button>
                    }
                    @if(currentStep() === 2) {
                        <button type="button" class="cancel-btn" (click)="prevStep()">Back</button>
                        <button type="button" class="save-btn" (click)="nextStep()">Next</button>
                    }
                    @if(currentStep() === 3) {
                        <button type="button" class="cancel-btn" (click)="prevStep()">Back</button>
                        <button type="submit" class="save-btn" [disabled]="!addRecipeForm.valid || ingredients.length === 0">Finish</button>
                    }
                </div>
            </form>
        </div>
    </div>
    }
    @if(selectedMeal()){
    <div class="recipie-item-big">
      @if(!isShared()){
        <div
          class="tofavorite"
          (click)="
              notFav
                ? addTofavorite()
                : deleteFromFavorite()
            "
        >
          <img
            src="{{ notFav ? 'assets/favorite.png' : 'assets/delete.png' }}"
            alt=""
          />
        </div>
      }
      @if(selectedMeal()!.isCustom && !isShared()){
      <div class="publish" (click)="publishToCommunity()">
        <!-- <img src="assets/publish.png" alt="+" /> -->

         <span>{{ selectedMeal()!.published ? '-' : '+' }}</span>
      </div>
      }
      <img
        class="back-img"
        src="{{ selectedMeal()!.strMealThumb }}"
        alt="steak"
      />
      <div class="blur-back-img"></div>
      <div class="recipie-info">
        <div class="recipie-category">{{ selectedMeal()!.strCategory }}</div>
        <div class="recipie-title">
          {{ selectedMeal()!.strMeal }} - {{ selectedMeal()!.strArea }}
          @if(selectedMeal()!.strTags) {
          <span class="tags"
            >, {{ selectedMeal()!.strTags.split(",")[0] }}</span
          >
          }
        </div>

      @if(!isShared() || loginEmail() !== selectedMealFollowedByEmail()){
        <div class="read-more" (click)="ViewuserDetail(selectedMeal()!)">
          Lets's cook it...
        </div>
      }
      </div>
      <!-- <div class="lier-one"></div>
        <div class="lier-two"></div> -->
    </div>
    }

    <form class="recepies-search" [formGroup]="searchForm">
      <input
        type="text"
        formControlName="search"
        placeholder="What we cook today..."
      />
      @if(searchMealsInStok() && searchMealsInStok().length > 0) {
      <select
        name="searchMeals"
        id="searchMeals"
        class="searchMeals"
        formControlName="searchMeal"
      >
        @for (meal of searchMealsInStok(); track $index) {
        <option [value]="$index">{{ meal.strMeal }}</option>
        }
      </select>
      }
    </form>

    <form [formGroup]="searchToFollowForm" (ngSubmit)="searchToFollowFormSubmit()">
      <div class="search-to-follow">
        <h2>Search to follow</h2>
        <input type="text" placeholder="Search..." formControlName="search"/>
        <button type="submit">Search</button>
      </div>
    </form>


    <div class="favorite-list-wrapper">
      <h2 class="favorite">Favorite :</h2>
      <div class="favorite-list">
        @for (meal of favoriteMealList(); track $index) {
        <div class="recipie-item-small">
          <img
            class="back-img"
            (click)="selectMeal(meal, false)"
            src="{{ meal.strMealThumb }}"
            alt="steak"
          />
        </div>
        }@empty {
        <div class="empty-favorite">
          <p>No favorite meals yet.</p>
        </div>
        }
      </div>
    </div>
    @if(sharedMealList().length > 0){
    <div class="favorite-list-wrapper">
      <h2 class="favorite">Shared Recipies :</h2>
      <div class="favorite-list">
        @for (meal of sharedMealList(); track $index) {
        <div class="recipie-item-small">
          <img
            class="back-img"
            (click)="selectMeal(meal, true, true)"
            src="{{ meal.strMealThumb }}"
            alt="steak"
          />
        </div>
        }@empty {
        <div class="empty-favorite">
          <p>No favorite meals yet.</p>
        </div>
        }
      </div>
      </div>
    }

    @if(followedSharedMealList().length > 0){
    <div class="favorite-list-wrapper">
      @for (meal of followedSharedMealList(); track $index) {
      <h2 class="favorite">{{ meal.followedByEmail }}</h2>
      <div class="favorite-list">
        @for (mealItem of meal.mealList; track $index) {
        <div class="recipie-item-small">
          <img
            class="back-img"
            (click)="selectMeal(mealItem, true, true, meal.followedByEmail)"
            src="{{ mealItem.strMealThumb }}"
            alt="steak"
          />
        </div>
        }@empty {
        <div class="empty-favorite">
          <p>No favorite meals yet.</p>
        </div>
        }
      </div>
    }
      </div>
    }

    @if(tenMealsInStok){
    <div class="random-list-wrapper">
      <h2 class="random">Random Recipies :</h2>
      <div class="random-list">
        @for(meal of tenMealsInStok; track $index){
        <div class="recipie-item-small">
          <img
            class="back-img"
            (click)="selectMeal(meal, true)"
            src="{{ meal.strMealThumb }}"
            [alt]="meal.strMeal"
          />
        </div>
        }
      </div>
    </div>
    }
  </section>

    @if(showSearchPopup()) {
      <div class="search-result-overlay">
          <div class="search-result-container">
              <div class="header">
                  <h2>Found Recipes</h2>
                  <div class="close-btn" (click)="closeSearchPopup()">
                       <ion-icon name="close-outline"></ion-icon>
                  </div>
              </div>
              <div class="results-list">
                  @for(meal of foundMeals(); track $index) {
                      <div class="recipie-item-small" (click)="selectMeal(meal, true); closeSearchPopup()">
                          <img [src]="meal.strMealThumb" class="back-img">
                          <div class="title">{{ meal.strMeal }}</div>
                      </div>
                  } @empty {
                       <p class="empty-msg">No recipes found.</p>
                  }
              </div>
          </div>
      </div>
    }
</ion-content>
